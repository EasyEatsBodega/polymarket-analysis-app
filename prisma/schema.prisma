// PredictEasy - Polymarket Intelligence Platform
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum TitleType {
  SHOW
  MOVIE
}

enum SignalSource {
  TRENDS
  WIKIPEDIA
}

enum GeoRegion {
  US
  GLOBAL
}

enum ForecastTarget {
  VIEWERSHIP
  RANK
  TREND_SCORE
}

enum JobStatus {
  RUNNING
  SUCCESS
  FAIL
}

enum CandidateStatus {
  PENDING   // Discovered, not yet matched
  MATCHED   // Linked to Title
  REJECTED  // Admin rejected
  RELEASED  // Appeared in Top 10
}

// =============================================================================
// CORE MODELS
// =============================================================================

model Title {
  id            String   @id @default(cuid())
  canonicalName String
  type          TitleType
  aliases       Json?
  tmdbId        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  weeklyGlobal       NetflixWeeklyGlobal[]
  weeklyUS           NetflixWeeklyUS[]
  dailySignals       DailySignal[]
  forecasts          ForecastWeekly[]
  marketLinks        MarketTitleLink[]
  externalIds        TitleExternalId[]
  releaseCandidates  ReleaseCandidate[]
  pinnedTitle        PinnedTitle?
  pacingMetrics      PacingMetricDaily[]

  @@unique([canonicalName, type])
}

model NetflixWeeklyGlobal {
  id        String    @id @default(cuid())
  titleId   String
  title     Title     @relation(fields: [titleId], references: [id])
  weekStart DateTime
  weekEnd   DateTime
  rank      Int
  category  String
  views        BigInt?
  hoursViewed  BigInt?
  runtimeHours Float?
  createdAt DateTime  @default(now())

  @@unique([titleId, weekStart, category])
  @@index([weekStart])
}

model NetflixWeeklyUS {
  id        String    @id @default(cuid())
  titleId   String
  title     Title     @relation(fields: [titleId], references: [id])
  weekStart DateTime
  weekEnd   DateTime
  rank      Int
  category  String
  createdAt DateTime  @default(now())

  @@unique([titleId, weekStart, category])
  @@index([weekStart])
}

model DailySignal {
  id        String       @id @default(cuid())
  titleId   String
  title     Title        @relation(fields: [titleId], references: [id])
  date      DateTime
  source    SignalSource
  geo       GeoRegion    @default(US)
  value     Float
  rawJson   Json?
  createdAt DateTime     @default(now())

  @@unique([titleId, date, source, geo])
  @@index([date])
}

model ForecastWeekly {
  id           String         @id @default(cuid())
  titleId      String
  title        Title          @relation(fields: [titleId], references: [id])
  weekStart    DateTime
  weekEnd      DateTime
  target       ForecastTarget
  p10          Float
  p50          Float
  p90          Float
  modelVersion String
  explainJson  Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([titleId, weekStart, target])
  @@index([weekStart])
}

// =============================================================================
// POLYMARKET MODELS
// =============================================================================

model PolymarketMarket {
  id          String    @id @default(cuid())
  conditionId String    @unique
  slug        String?
  question    String
  description String?
  outcomes    Json
  category    String?
  endDate     DateTime?
  resolved    Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  prices      MarketPriceSnapshot[]
  titleLinks  MarketTitleLink[]
}

model MarketPriceSnapshot {
  id        String           @id @default(cuid())
  marketId  String
  market    PolymarketMarket @relation(fields: [marketId], references: [id])
  timestamp DateTime         @default(now())
  prices    Json
  volume    Float?
  liquidity Float?

  @@index([marketId, timestamp])
}

model MarketTitleLink {
  id        String           @id @default(cuid())
  marketId  String
  market    PolymarketMarket @relation(fields: [marketId], references: [id])
  titleId   String
  title     Title            @relation(fields: [titleId], references: [id])
  createdAt DateTime         @default(now())

  @@unique([marketId, titleId])
}

// =============================================================================
// RELEASE WATCHLIST MODELS
// =============================================================================

model ReleaseCandidate {
  id          String          @id @default(cuid())
  name        String          // Raw name from source
  type        TitleType       // SHOW or MOVIE
  releaseDate DateTime?       // Expected/actual release date
  source      String          // "tudum", "tmdb", "manual"
  sourceId    String?         // External ID from source
  status      CandidateStatus @default(PENDING)
  titleId     String?         // Linked Title once matched
  title       Title?          @relation(fields: [titleId], references: [id])
  metadata    Json?           // Extra info (poster, description)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([source, sourceId])
  @@index([status])
  @@index([releaseDate])
}

model TitleExternalId {
  id         String   @id @default(cuid())
  titleId    String
  title      Title    @relation(fields: [titleId], references: [id])
  provider   String   // "tmdb", "imdb", "wikipedia"
  externalId String
  createdAt  DateTime @default(now())

  @@unique([titleId, provider])
  @@unique([provider, externalId])
}

model PinnedTitle {
  id       String   @id @default(cuid())
  titleId  String   @unique
  title    Title    @relation(fields: [titleId], references: [id])
  pinnedAt DateTime @default(now())
  pinnedBy String?  // User ID who pinned

  @@index([pinnedAt])
}

model PacingMetricDaily {
  id           String   @id @default(cuid())
  titleId      String
  title        Title    @relation(fields: [titleId], references: [id])
  date         DateTime
  trendsUS     Float?   // Google Trends US (0-100)
  trendsGlobal Float?   // Google Trends Global (0-100)
  wikiViews    Float?   // Wikipedia pageviews
  pacingScore  Float?   // Computed composite score (0-100)
  createdAt    DateTime @default(now())

  @@unique([titleId, date])
  @@index([date])
}

// =============================================================================
// SYSTEM MODELS
// =============================================================================

model AppConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?
}

model JobRun {
  id          String    @id @default(cuid())
  jobName     String
  status      JobStatus
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  error       String?
  detailsJson Json?

  @@index([jobName, startedAt])
}
