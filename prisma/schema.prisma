// PredictEasy - Polymarket Intelligence Platform
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum TitleType {
  SHOW
  MOVIE
}

enum SignalSource {
  TRENDS
  WIKIPEDIA
}

enum GeoRegion {
  US
  GLOBAL
}

enum ForecastTarget {
  VIEWERSHIP
  RANK
  TREND_SCORE
}

enum JobStatus {
  RUNNING
  SUCCESS
  FAIL
}

enum CandidateStatus {
  PENDING   // Discovered, not yet matched
  MATCHED   // Linked to Title
  REJECTED  // Admin rejected
  RELEASED  // Appeared in Top 10
}

// =============================================================================
// CORE MODELS
// =============================================================================

model Title {
  id            String   @id @default(cuid())
  canonicalName String
  type          TitleType
  aliases       Json?
  tmdbId        Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  weeklyGlobal       NetflixWeeklyGlobal[]
  weeklyUS           NetflixWeeklyUS[]
  dailySignals       DailySignal[]
  forecasts          ForecastWeekly[]
  marketLinks        MarketTitleLink[]
  externalIds        TitleExternalId[]
  releaseCandidates  ReleaseCandidate[]
  pinnedTitle        PinnedTitle?
  pacingMetrics      PacingMetricDaily[]
  flixPatrolDaily    FlixPatrolDaily[]
  flixPatrolTrailers FlixPatrolTrailer[]
  flixPatrolSocial   FlixPatrolSocial[]

  @@unique([canonicalName, type])
}

model NetflixWeeklyGlobal {
  id        String    @id @default(cuid())
  titleId   String
  title     Title     @relation(fields: [titleId], references: [id])
  weekStart DateTime
  weekEnd   DateTime
  rank      Int
  category  String
  views        BigInt?
  hoursViewed  BigInt?
  runtimeHours Float?
  createdAt DateTime  @default(now())

  @@unique([titleId, weekStart, category])
  @@index([weekStart])
}

model NetflixWeeklyUS {
  id        String    @id @default(cuid())
  titleId   String
  title     Title     @relation(fields: [titleId], references: [id])
  weekStart DateTime
  weekEnd   DateTime
  rank      Int
  category  String
  createdAt DateTime  @default(now())

  @@unique([titleId, weekStart, category])
  @@index([weekStart])
}

model FlixPatrolDaily {
  id          String    @id @default(cuid())
  titleId     String?   // Nullable - may not match existing title
  title       Title?    @relation(fields: [titleId], references: [id])
  date        DateTime
  platform    String    @default("netflix")
  region      String    @default("world")
  category    String    // "tv" or "movies"
  rank        Int
  points      Int       // FlixPatrol points score
  titleName   String    // Raw title name from FlixPatrol
  titleSlug   String    // FlixPatrol URL slug (e.g., "stranger-things")
  createdAt   DateTime  @default(now())

  @@unique([date, platform, region, category, rank])
  @@index([date])
  @@index([titleSlug])
  @@index([titleId])
}

// FlixPatrol trailer data - fetched every 48 hours for Polymarket titles
model FlixPatrolTrailer {
  id              String    @id @default(cuid())
  titleId         String
  title           Title     @relation(fields: [titleId], references: [id])
  fpTrailerId     String    // FlixPatrol trailer ID
  trailerTitle    String    // YouTube video title
  premiereDate    DateTime? // When trailer was published
  views           Int       // YouTube views
  likes           Int       // YouTube likes
  dislikes        Int       // YouTube dislikes
  engagementRatio Float     // likes / (likes + dislikes) * 100
  fetchedAt       DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@unique([titleId, fpTrailerId, fetchedAt])
  @@index([titleId])
  @@index([fetchedAt])
}

// FlixPatrol social followers - fetched every 48 hours for Polymarket titles
model FlixPatrolSocial {
  id          String    @id @default(cuid())
  titleId     String
  title       Title     @relation(fields: [titleId], references: [id])
  platform    String    // "facebook", "twitter", "instagram", "reddit"
  followers   Int       // Current follower count
  change      Int       // Change since last fetch
  fetchedAt   DateTime  @default(now())
  createdAt   DateTime  @default(now())

  @@unique([titleId, platform, fetchedAt])
  @@index([titleId])
  @@index([fetchedAt])
}

model DailySignal {
  id        String       @id @default(cuid())
  titleId   String
  title     Title        @relation(fields: [titleId], references: [id])
  date      DateTime
  source    SignalSource
  geo       GeoRegion    @default(US)
  value     Float
  rawJson   Json?
  createdAt DateTime     @default(now())

  @@unique([titleId, date, source, geo])
  @@index([date])
}

model ForecastWeekly {
  id           String         @id @default(cuid())
  titleId      String
  title        Title          @relation(fields: [titleId], references: [id])
  weekStart    DateTime
  weekEnd      DateTime
  target       ForecastTarget
  p10          Float
  p50          Float
  p90          Float
  modelVersion String
  explainJson  Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([titleId, weekStart, target])
  @@index([weekStart])
}

// =============================================================================
// POLYMARKET MODELS
// =============================================================================

model PolymarketMarket {
  id          String    @id @default(cuid())
  conditionId String    @unique
  slug        String?
  question    String
  description String?
  outcomes    Json
  category    String?
  endDate     DateTime?
  resolved    Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  prices      MarketPriceSnapshot[]
  titleLinks  MarketTitleLink[]
}

model MarketPriceSnapshot {
  id        String           @id @default(cuid())
  marketId  String
  market    PolymarketMarket @relation(fields: [marketId], references: [id])
  timestamp DateTime         @default(now())
  prices    Json
  volume    Float?
  liquidity Float?

  @@index([marketId, timestamp])
}

model MarketTitleLink {
  id        String           @id @default(cuid())
  marketId  String
  market    PolymarketMarket @relation(fields: [marketId], references: [id])
  titleId   String
  title     Title            @relation(fields: [titleId], references: [id])
  createdAt DateTime         @default(now())

  @@unique([marketId, titleId])
}

// =============================================================================
// RELEASE WATCHLIST MODELS
// =============================================================================

model ReleaseCandidate {
  id          String          @id @default(cuid())
  name        String          // Raw name from source
  type        TitleType       // SHOW or MOVIE
  releaseDate DateTime?       // Expected/actual release date
  source      String          // "tudum", "tmdb", "manual"
  sourceId    String?         // External ID from source
  status      CandidateStatus @default(PENDING)
  titleId     String?         // Linked Title once matched
  title       Title?          @relation(fields: [titleId], references: [id])
  metadata    Json?           // Extra info (poster, description)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([source, sourceId])
  @@index([status])
  @@index([releaseDate])
}

model TitleExternalId {
  id         String   @id @default(cuid())
  titleId    String
  title      Title    @relation(fields: [titleId], references: [id])
  provider   String   // "tmdb", "imdb", "wikipedia"
  externalId String
  createdAt  DateTime @default(now())

  @@unique([titleId, provider])
  @@unique([provider, externalId])
}

model PinnedTitle {
  id       String   @id @default(cuid())
  titleId  String   @unique
  title    Title    @relation(fields: [titleId], references: [id])
  pinnedAt DateTime @default(now())
  pinnedBy String?  // User ID who pinned

  @@index([pinnedAt])
}

model PacingMetricDaily {
  id           String   @id @default(cuid())
  titleId      String
  title        Title    @relation(fields: [titleId], references: [id])
  date         DateTime
  trendsUS     Float?   // Google Trends US (0-100)
  trendsGlobal Float?   // Google Trends Global (0-100)
  wikiViews    Float?   // Wikipedia pageviews
  pacingScore  Float?   // Computed composite score (0-100)
  createdAt    DateTime @default(now())

  @@unique([titleId, date])
  @@index([date])
}

// =============================================================================
// SYSTEM MODELS
// =============================================================================

model AppConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
  updatedBy String?
}

model JobRun {
  id          String    @id @default(cuid())
  jobName     String
  status      JobStatus
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  error       String?
  detailsJson Json?

  @@index([jobName, startedAt])
}

// =============================================================================
// INSIDER FINDER MODELS
// =============================================================================

enum InsiderBadgeType {
  HIGH_WIN_RATE   // 80%+ win rate
  BIG_BET         // Trade >50% of their total volume
  LONG_SHOT       // Bought at <25%, was correct
  PRE_MOVE        // Price moved 20%+ within 24h of trade
  LATE_WINNER     // Correct bet within 7 days of resolution
  FIRST_MOVER     // Among first 10 traders on market
  FRESH_WALLET    // Wallet less than 7 days old
  SINGLE_MARKET   // Only traded on one market
}

model InsiderWallet {
  id              String   @id @default(cuid())
  address         String   @unique
  proxyWallet     String?  // Polymarket proxy wallet if different
  firstTradeAt    DateTime
  lastTradeAt     DateTime
  totalTrades     Int      @default(0)
  totalVolume     Float    @default(0)
  winRate         Float?
  resolvedTrades  Int      @default(0)
  wonTrades       Int      @default(0)
  isTracked       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  trades          InsiderTrade[]
  badges          InsiderBadge[]

  @@index([firstTradeAt])
  @@index([totalTrades])
  @@index([isTracked])
}

model InsiderTrade {
  id              String   @id @default(cuid())
  walletId        String
  wallet          InsiderWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)
  conditionId     String   // Polymarket market condition ID
  marketQuestion  String   // Cached market question
  marketSlug      String?  // Market slug for linking
  marketCategory  String?  // Market category for filtering
  outcomeName     String   // e.g., "Yes", "No", or specific outcome
  side            String   // BUY or SELL
  size            Float    // Number of shares
  price           Float    // Entry price (0-1)
  usdValue        Float    // Total USD value
  timestamp       DateTime
  transactionHash String?

  // Resolution data (filled when market resolves)
  resolved        Boolean  @default(false)
  resolvedAt      DateTime?
  won             Boolean?
  pnl             Float?

  // Badge qualification data
  priceAtTrade    Float?   // Market price when trade was made
  price24hLater   Float?   // Price 24h after trade
  daysToResolution Int?    // Days between trade and resolution
  traderRank      Int?     // Position among market traders (1 = first)

  createdAt       DateTime @default(now())

  @@unique([walletId, conditionId, transactionHash])
  @@index([walletId, timestamp])
  @@index([conditionId])
  @@index([marketCategory])
  @@index([timestamp])
}

model InsiderBadge {
  id          String           @id @default(cuid())
  walletId    String
  wallet      InsiderWallet    @relation(fields: [walletId], references: [id], onDelete: Cascade)
  tradeId     String?          // Optional: specific trade that earned badge
  badgeType   InsiderBadgeType
  reason      String           // Human-readable reason
  metadata    Json?            // Additional context
  earnedAt    DateTime         @default(now())

  @@unique([walletId, tradeId, badgeType])
  @@index([walletId])
  @@index([badgeType])
}

// =============================================================================
// AWARDS MODELS
// =============================================================================

enum AwardShowStatus {
  UPCOMING    // Ceremony not yet happened
  ACTIVE      // Markets open, ceremony approaching
  COMPLETED   // Ceremony finished, results known
}

enum OddsSource {
  POLYMARKET
  DRAFTKINGS
  BETMGM
  BOVADA
  MYBOOKIE
  GOLDDERBY
}

model AwardShow {
  id            String          @id @default(cuid())
  name          String          // "Golden Globes 2026"
  slug          String          @unique // "golden-globes-2026"
  ceremonyDate  DateTime
  status        AwardShowStatus @default(UPCOMING)
  description   String?
  imageUrl      String?
  categories    AwardCategory[]
  articles      AwardArticle[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([ceremonyDate])
  @@index([status])
}

model AwardCategory {
  id              String          @id @default(cuid())
  showId          String
  show            AwardShow       @relation(fields: [showId], references: [id], onDelete: Cascade)
  name            String          // "Best Director"
  slug            String          // "best-director"
  polymarketSlug  String?         // "golden-globes-best-director-winner"
  polymarketUrl   String?
  displayOrder    Int             @default(0)
  nominees        AwardNominee[]
  articles        AwardArticle[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([showId, slug])
  @@index([showId])
}

model AwardNominee {
  id            String          @id @default(cuid())
  categoryId    String
  category      AwardCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  name          String          // "Paul Thomas Anderson"
  subtitle      String?         // "One Battle After Another" (film name)
  imageUrl      String?
  isWinner      Boolean         @default(false)
  odds          AwardOdds[]
  oddsSnapshots AwardOddsSnapshot[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([categoryId])
  @@index([isWinner])
}

model AwardOdds {
  id          String      @id @default(cuid())
  nomineeId   String
  nominee     AwardNominee @relation(fields: [nomineeId], references: [id], onDelete: Cascade)
  source      OddsSource
  probability Float       // 0.0 to 1.0
  rawOdds     String?     // Original format: "+150", "2/1"
  url         String?     // Link to source market
  fetchedAt   DateTime    @default(now())

  @@unique([nomineeId, source])
  @@index([nomineeId])
  @@index([source])
}

model AwardOddsSnapshot {
  id          String      @id @default(cuid())
  nomineeId   String
  nominee     AwardNominee @relation(fields: [nomineeId], references: [id], onDelete: Cascade)
  source      OddsSource
  probability Float
  snapshotAt  DateTime    @default(now())

  @@index([nomineeId, snapshotAt])
  @@index([snapshotAt])
}

model AwardArticle {
  id          String         @id @default(cuid())
  showId      String
  show        AwardShow      @relation(fields: [showId], references: [id], onDelete: Cascade)
  categoryId  String?        // Optional - can be show-wide
  category    AwardCategory? @relation(fields: [categoryId], references: [id])
  source      String         // "Variety", "IndieWire", "Gold Derby"
  title       String
  url         String         @unique
  author      String?
  publishedAt DateTime?
  summary     String?        // AI-generated summary
  predictions Json?          // Extracted predictions
  fetchedAt   DateTime       @default(now())

  @@index([showId])
  @@index([categoryId])
  @@index([publishedAt])
}
